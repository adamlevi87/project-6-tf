# Project-6 Infrastructure Setup Guide

## Overview
This project deploys an EKS cluster with ArgoCD, a sample application, and GitOps workflow using Terraform.

## Prerequisites
- AWS CLI configured with appropriate permissions
- Terraform installed
- GitHub account with organization access

## Setup Instructions

### 1. AWS Infrastructure Prerequisites

Navigate to the `.requirements` folder and run:
```bash
cd .requirements
terraform init
terraform apply
```

This creates the foundational AWS resources. **Save the outputs:**
```
aws_iam_openid_connect_provider_github_arn = "arn:aws:iam::ACCOUNT:oidc-provider/token.actions.githubusercontent.com"
github_oidc_role_arn = "arn:aws:iam::ACCOUNT:role/PROJECT_NAME-role-for-manual-tf"
```

### 2. GitHub Personal Access Token

Create a fine-grained PAT at: https://github.com/settings/personal-access-tokens

**Required permissions for both application and GitOps repositories:**
- Actions (read/write)
- Contents (read/write)
- Pull requests (read/write)
- Secrets (read/write)
- Variables (read/write)

### 3. GitHub Application for ArgoCD

1. Create new GitHub App: https://github.com/settings/apps/new
2. Configuration:
   - **Name:** Choose descriptive name
   - **Homepage URL:** Your GitOps repository URL
   - **Webhook:** Uncheck "Active"
   - **Repository permissions:** Contents (read)
   - **Installation:** Only on this account
3. After creation:
   - Generate and download private key
   - Note the App ID from the app settings page
4. Install the app:
   - Go to https://github.com/settings/installations
   - Install app on both application and GitOps repositories
   - Note the Installation ID from the URL

### 4. GitHub OAuth Application for ArgoCD SSO

1. Go to your GitHub organization: https://github.com/organizations/YOUR_ORG/settings/applications
2. Create OAuth App:
   - **Application name:** Choose descriptive name
   - **Homepage URL:** Must match your Terraform configuration
   - **Authorization callback URL:** Homepage URL + `/api/dex/callback`

**Important:** The ArgoCD URL is automatically generated by Terraform using these variables:
- Format: `https://{argocd_base_domain_name}-{environment}.{subdomain_name}.{domain_name}`
- Example: `https://argocd-dev.project-6.projects-devops.cfd`
- Configure these in your `terraform.tfvars`:
  ```hcl
  argocd_base_domain_name = "argocd"
  environment = "dev" 
  subdomain_name = "project-6"
  domain_name = "projects-devops.cfd"
  ```

You cannot choose the URL arbitrarily - it must match your Terraform domain configuration.

### 5. GitHub Organization Teams

Create two teams in your GitHub organization:
- **developers:** Read-only access to ArgoCD
- **devops:** Full admin access to ArgoCD
* Update their names in the tfvars (github_admin_team ,github_readonly_team)

### 6. Repository Secrets Configuration

#### Terraform Repository Secrets
Set these in your **project-6-tf** repository settings:

**Environment-Independent Secrets:**
```
PROVIDER_GITHUB_ARN = arn:aws:iam::ACCOUNT:oidc-provider/token.actions.githubusercontent.com
AWS_ROLE_TO_ASSUME = arn:aws:iam::ACCOUNT:role/project-6-dev-initial-role-for-tf
TOKEN_GITHUB = github_pat_YOUR_TOKEN
```

**Environment-Specific Secrets:**
For each environment (dev/staging/prod), create:
```
ARGOCD_APP_ID_TF_DEV = YOUR_GITHUB_APP_ID
ARGOCD_INSTALLATION_ID_TF_DEV = YOUR_INSTALLATION_ID
ARGOCD_PRIVATE_KEY_TF_DEV = BASE64_ENCODED_PRIVATE_KEY
OAUTH_GITHUB_CLIENT_ID_TF_DEV = YOUR_OAUTH_CLIENT_ID
OAUTH_GITHUB_CLIENT_SECRET_TF_DEV = YOUR_OAUTH_CLIENT_SECRET
```

**Note:** For the private key, base64 encode the entire key content (including BEGIN/END lines) as a single line. Ensure no extra spaces or newlines are added before or after the encoded content when pasting into the GitHub secret field.
suggestion: encode from a linux machine:
```bash
cat your-private-key.pem | base64 -w 0 > encoded.txt
```

#### Repository Variables
Set these in your **project-6-tf** repository:
```
AWS_REGION = us-east-1
```

### 7. Deployment

1. **Initialize Terraform:**
   ```bash
   cd main
   terraform init
   ```

2. **Plan and review changes:**
   ```bash
   terraform plan -var-file="../environments/dev/terraform.tfvars"
   ```

3. **Bootstrap deployment:**
   ```bash
   terraform apply --auto-approve \
     --var-file="../environments/dev/terraform.tfvars" \
     --var="auto_merge_pr=true" \
     --var="bootstrap_mode=true"
   ```

4. **Access ArgoCD:**
   - URL: Automatically generated as `https://{argocd_base_domain_name}-{environment}.{subdomain_name}.{domain_name}`
   - For default config: `https://argocd-dev.project-6.projects-devops.cfd`
   - Login with GitHub SSO (authorize the application on first login)

5. **Subsequent updates:**
   ```bash
   terraform apply --auto-approve \
     --var-file="../environments/dev/terraform.tfvars" \
     --var="bootstrap_mode=false" \
     --var="update_apps=true"
   ```

## Workflow Variables Summary

- **auto_merge_pr:** Controls automatic PR merging in GitOps repository (triggers a Gitops repo workflow to merge)
- **bootstrap_mode:** Creates yamls in the GitOps Repository: (Creates a PR)
                        ArgoCD project and app-of-apps yaml are for reference only (they are deployed using helm).Applications and their value files are also created.
                        
                    This mode also Triggers the Application Repository's workflow that builds the app, pushes to ECR, creates a GitOps PR to update the digest, and triggers a Gitops Repo workflow to merge it.
- **update_apps:** Updates infrastructure values in GitOps repository only (Creates a PR)

## Troubleshooting

### ArgoCD Access Issues
- Verify DNS propagation (can take 10-20 minutes)
- Check ALB target health
- Ensure your IP is whitelisted in `argocd_allowed_cidr_blocks`

### GitHub Authentication
- Ensure GitHub App is installed on both repositories
- Verify OAuth application callback URL matches ArgoCD domain
- Check organization team membership for proper RBAC access

### Workflow Triggers
- Verify all environment-specific secrets exist
- Check GitHub Actions logs for API permission errors
- Ensure workflows have proper permissions configured